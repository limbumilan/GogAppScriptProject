<!DOCTYPE html>
<html>
<head>
  <base target="_top">

  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- Google Icons & Fonts -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=chevron_left" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- External Stylesheet -->
  <?!= include('stylesheet') ?>
</head>
<body>

<div class="app">

  <!-- ========================
       SIDEBAR
       ======================== -->
  <aside class="sidebar collapsed" id="sidebar">

    <!-- TOGGLE BUTTON -->
    <div class="sidebar-toggle" onclick="toggleSidebar()">
      <span class="material-symbols-outlined">chevron_left</span>
    </div>

    <!-- TOP NAV -->
    <ul class="nav nav-top">

      <!-- Dashboard -->
      <li class="nav-item active" data-tooltip="Dashboard" onclick="activate(this); showTab('dashboardTab')">
        <span class="material-icons">dashboard</span>
        <span class="label">Dashboard</span>
      </li>

      <!-- Reports (Click Dropdown) -->
      <li class="nav-item has-dropdown click-dropdown"  onclick="toggleDropdown(event, this)">
        <span class="material-icons">bar_chart</span>
        <span class="label">Reports</span>
        <ul class="entry-submenu">
          <li onclick="showTab('allreportTab')">All Reports</li>
          <li onclick="showTab('reportsTab')">General Report</li>
        </ul>
      </li>

      <!-- Entry Submenu -->
      <li class="nav-item has-dropdown click-dropdown"  onclick="toggleDropdown(event, this)" >
        <span class="material-icons">edit</span>
        <span class="label">Entry</span>
        <ul class="entry-submenu">
          <li onclick="showTab( 'entryTab')">Add New</li>
          <li onclick="showTab('editTab')">Edit</li>
          <li onclick="showTab('verifyTab')">verify</li>
        </ul>
      </li>

    </ul>

    <!-- BOTTOM NAV -->
    <ul class="nav nav-bottom">
      <li class="nav-item" data-tooltip="Settings" onclick="alert('Settings coming soon')">
        <span class="material-icons">settings</span>
        <span class="label">Settings</span>
      </li>

      <li class="nav-item logout" data-tooltip="Logout">
        <a href="<?= webAppUrl ?>?v=login">
          <span class="material-icons">logout</span>
          <span class="label">Logout</span>
        </a>
      </li>
  
  </aside>

  <!-- ========================
       MAIN CONTENT
       ======================== -->
  <main class="main">

    <!-- DASHBOARD TAB -->
    <div id="dashboardTab">
      <div class="topbar">
        <h2>Overview</h2>
        <div class="user-profile-trigger" onclick="toggleUserMenu()" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
    <span>ðŸ‘¤ <span id="display-name"><?= username ?></span></span>
      </div>
        
      </div>

      <!-- KPI Cards -->
      <div class="kpis">
        <div class="card kpi">
          <h3>Total Cards Printed</h3>
          <h2 id="totalRecords">â€“</h2>
        </div>
        <div class="card kpi">
          <h3>Total Unprinted Cards</h3>
          <h2 id="totalCategories">â€“</h2>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts">
        <div class="card">
          <h3>Applications by Category</h3>
          <div id="categoryChart" style="height:300px;"></div>
        </div>
        <div class="card">
          <h3>Applications by Date</h3>
          <div id="dateChart" style="height:300px;"></div>
        </div>
      </div>

      <!-- Recent Applications Table -->
      <div class="card">
        <h3>Recent Applications</h3>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Name</th>
              <th>Category</th>
              <th>Contact</th>
              <th>Verified</th>
            </tr>
          </thead>
          <tbody id="dataTable"></tbody>
        </table>
      </div>
    </div>

    <!-- REPORTS TAB -->
    <div id="reportsTab" style="display:none;">
      <?!= include('report') ?>
      
    </div>
    <!-- ADDNEW TAB -->
    <div id="entryTab" style="display:none;">
     <?!= include('addnew') ?>
      
    </div>

    <!-- EDIT TAB -->
    <div id="editTab" style="display:none;">
  <?!= include('edit') ?>
     </div>
  <!-- VERIFY TAB -->
  <div id="verifyTab" style="display:none;">
  <?!= include('verify') ?>
     </div>


   <!-- GENERAL REPORT TAB -->
<div id="allreportTab" style="display:none;">
  <?!= include('allreport') ?>
</div>






  </main>

</div>


<div id="passwordModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
  <div style="background:#fff; padding:25px; border-radius:12px; width:320px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
    <h3 style="margin-top:0; color:#4f46e5;">User Settings</h3>
    <p style="font-size: 13px; color: #666;">Role: <strong id="userRoleBadge">Loading...</strong></p>
    
    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
    
    <label style="font-size:12px; font-weight:600;">Change Password</label>
    <input type="password" id="newPassword" placeholder="Enter new password" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
    
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
      <button onclick="closePasswordModal()" style="background:#f3f4f6; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Cancel</button>
      <button onclick="submitPasswordChange()" style="background:#4f46e5; color:#fff; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Update</button>
    </div>
  </div>
</div>



<!-- ========================
     JAVASCRIPT
     ======================== -->
<script>
/* =======================
   SIDEBAR COLLAPSE STATE
   ======================= */
let USER_ROLE = "";

// 1. Fetch user session and apply security on load
window.addEventListener('load', function() {
  google.script.run.withSuccessHandler(function(session) {
    USER_ROLE = session.role; 
    
    // Update the UI badges
    const roleBadge = document.getElementById('userRoleBadge');
    if(roleBadge) roleBadge.innerText = USER_ROLE;
    
    console.log("Session Loaded. User:", session.username, "Role:", USER_ROLE);
    
    applyPermissions(USER_ROLE);
  }).getUserSession();
});

function applyPermissions(role) {
  // Convert to uppercase to prevent case-sensitivity issues
  const userRole = (role || "").toUpperCase();
  
  const btnEdit = document.getElementById('nav-edit');
  const btnVerify = document.getElementById('nav-verify');
  const btnAddNew = document.getElementById('nav-addnew');

  // Helper to safely set display
  const setDisplay = (el, val) => { if(el) el.style.display = val; };

  if (userRole === 'VERIFIER') {
    setDisplay(btnEdit, 'none');
    setDisplay(btnAddNew, 'none');
    setDisplay(btnVerify, 'block');
  } 
  else if (userRole === 'DISTRIBUTOR') {
    setDisplay(btnEdit, 'none');
    setDisplay(btnVerify, 'none');
    setDisplay(btnAddNew, 'block');
  }
  else if (userRole === 'ADMIN') {
    setDisplay(btnEdit, 'block');
    setDisplay(btnVerify, 'block');
    setDisplay(btnAddNew, 'block');
  } else {
    // Unknown role: Hide everything sensitive for safety
    setDisplay(btnEdit, 'none');
    setDisplay(btnVerify, 'none');
    setDisplay(btnAddNew, 'none');
  }
}

// Security Wrapper for showTab
function showTab(tabId) {
  // Hard Security Check
  if (tabId === 'editTab' && USER_ROLE !== 'ADMIN') {
    alert("â›” Access Denied: Administrator privileges required.");
    return;
  }
  if (tabId === 'allreportTab' && USER_ROLE !== 'ADMIN') {
    alert("â›” Access Denied: Administrator privileges required.");
    return;
  }
  
  if (tabId === 'verifyTab' && (USER_ROLE !== 'ADMIN' && USER_ROLE !== 'VERIFIER')) {
    alert("â›” Access Denied: Verifier privileges required.");
    return;
  }

  // 1. UI: Hide all tab content containers
  const tabs = document.querySelectorAll('main > div');
  tabs.forEach(tab => tab.style.display = 'none');

  // 2. UI: Show the selected tab
  const target = document.getElementById(tabId);
  if (target) {
    target.style.display = 'block';
  }

  // 3. LOGIC: Data Refresh
  const tabActions = {
    'dashboardTab': () => typeof loadDashboard === 'function' && loadDashboard(),
    'reportsTab':   () => typeof loadReports === 'function' && loadReports(),
    'allreportTab': () => typeof fetchAllReportData === 'function' && fetchAllReportData(),
    'editTab':      () => typeof prepareEditTab === 'function' && prepareEditTab()
  };

  if (tabActions[tabId]) tabActions[tabId]();
}




const LOGGED_IN_USER = "<?= username ?>";
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const app = document.querySelector('.app');

  sb.classList.toggle('collapsed');
  const collapsed = sb.classList.contains('collapsed');

  // Store state
  localStorage.setItem('sidebarCollapsed', collapsed);

  // Adjust grid
  if(collapsed){
    app.style.gridTemplateColumns = '60px 1fr'; // sidebar collapsed
  } else {
    app.style.gridTemplateColumns = '240px 1fr'; // sidebar expanded
  }
}

// On page load, apply saved state
(function(){
  const sb = document.getElementById('sidebar');
  const app = document.querySelector('.app');
  const collapsed = localStorage.getItem('sidebarCollapsed') === 'true';
  if(collapsed){
    sb.classList.add('collapsed');
    app.style.gridTemplateColumns = '60px 1fr';
  } else {
    app.style.gridTemplateColumns = '240px 1fr';
  }
})();


/* =======================
   DROPDOWN LOGIC
   ======================= */
function toggleDropdown(event, el) {
  event.stopPropagation();
  const sidebar = document.getElementById('sidebar');

  // Close other dropdowns
  document.querySelectorAll('.click-dropdown').forEach(d => {
    if (d !== el) {
      d.classList.remove('open');
      d.classList.remove('active');
    }
  });

  // Toggle current dropdown
  if (sidebar.classList.contains('collapsed')) {
    // Collapsed â†’ floating
    el.classList.toggle('open');
    el.classList.remove('active'); // no inline submenu
  } else {
    // Expanded â†’ inline submenu
    el.classList.toggle('active');
    el.classList.remove('open'); // not floating
  }
}

// Close all floating dropdowns when clicking outside
document.addEventListener('click', () => {
  document.querySelectorAll('.click-dropdown').forEach(d => {
    d.classList.remove('open');
  });
});




/* =======================
   ACTIVE TAB HIGHLIGHT
   ======================= */



function activate(el){
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  el.classList.add('active');
}

/* =======================
   GOOGLE CHARTS + DASHBOARD LOGIC
   ======================= */
google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(loadDashboard);
















function loadDashboard() {
  google.script.run.withSuccessHandler(renderDashboard).getDashboardData();
}






function renderDashboard(data) {
  document.getElementById('totalRecords').textContent = data.totalRecords;
  document.getElementById('totalCategories').textContent = Object.keys(data.categories).length;

  // Category Chart
  const catData = [['Category','Count']];
  Object.entries(data.categories).forEach(([k,v])=>catData.push([k,v]));
  new google.visualization.PieChart(document.getElementById('categoryChart'))
    .draw(google.visualization.arrayToDataTable(catData), {pieHole:0.4});

  // Date Chart
  const dateData = [['Date','Count']];
  Object.entries(data.dateCounts).forEach(([k,v])=>dateData.push([k,v]));
  new google.visualization.ColumnChart(document.getElementById('dateChart'))
    .draw(google.visualization.arrayToDataTable(dateData), {legend:'none'});

  // Recent Applications Table
  const tbody = document.getElementById('dataTable');
  tbody.innerHTML='';
  data.table.slice(0,10).forEach(r=>{
    tbody.innerHTML+=`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td></tr>`;
  });


}






//passwordchaNGE//












// 2. Password Modal Functions
function toggleUserMenu() {
  document.getElementById('passwordModal').style.display = 'block';
}

function closePasswordModal() {
  document.getElementById('passwordModal').style.display = 'none';
  document.getElementById('newPassword').value = '';
}

function submitPasswordChange() {
  const newPass = document.getElementById('newPassword').value;
  if (!newPass) return alert("Please enter a new password.");

  const btn = event.target;
  btn.disabled = true;
  btn.innerText = "Updating...";

  google.script.run
    .withSuccessHandler(() => {
      alert("Password updated successfully!");
      closePasswordModal();
      btn.disabled = false;
      btn.innerText = "Update";
    })
    .withFailureHandler((err) => {
      alert("Error: " + err.message);
      btn.disabled = false;
    })
    .updateUserPassword(newPass);
}

// 3. Security Wrapper for showTab
// Prevents users from manually calling showTab('editTab') in the console
const originalShowTab = showTab;
showTab = function(tabId) {
  if (tabId === 'editTab' && USER_ROLE !== 'ADMIN') {
    alert("Access Denied: Admin only.");
    return;
  }
  originalShowTab(tabId);
};

</script>


</body>
</html>
